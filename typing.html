<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¼ë³¸ì–´ íƒ€ì ì—°ìŠµ ê²Œì„</title>
    <style>
        /* 1. ê²Œì„ ì „ìš© ë˜í¼ */
        #jp-typing-wrapper {
            font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; /* ì˜¤íƒ€ ìˆ˜ì •: justify_content -> justify-content */
            padding: 40px 20px;
            border-radius: 10px;
            margin: 30px auto; /* ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•´ auto ì¶”ê°€ */
            position: relative;
            
            /* ë³€ìˆ˜ ì„¤ì • */
            --container-width: 100%;
            --max-width: 450px;
            --char-size: 100px;
            --input-font: 20px;
            --input-height: 50px;
            --btn-padding: 8px 16px;
            --btn-font: 14px;
        }

        /* ì‚¬ì´ì¦ˆë³„ í´ë˜ìŠ¤ */
        #jp-typing-wrapper.size-small {
            --max-width: 350px;
            --char-size: 70px;
            --input-font: 16px;
            --input-height: 40px;
            --btn-padding: 6px 12px;
            --btn-font: 12px;
        }
        #jp-typing-wrapper.size-large {
            --max-width: 700px;
            --char-size: 180px;
            --input-font: 32px;
            --input-height: 70px;
            --btn-padding: 12px 24px;
            --btn-font: 18px;
        }

        /* ë‚´ë¶€ ì»¨í…Œì´ë„ˆ */
        #jp-typing-wrapper .game-container {
            background-color: #34495e;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            text-align: center;
            width: 100%;
            max-width: var(--max-width);
            position: relative;
            transition: max-width 0.3s;
            box-sizing: border-box; /* íŒ¨ë”© í¬í•¨ í¬ê¸° ê³„ì‚° */
        }

        /* íƒ€ì´í‹€ */
        #jp-typing-wrapper h2.game-title { 
            margin-top: 30px;
            font-size: 24px; 
            color: #ecf0f1; 
            border: none;
            margin-bottom: 20px;
        }

        /* ì‚¬ì´ì¦ˆ ì¡°ì ˆ ë²„íŠ¼ */
        .size-controls {
            position: absolute;
            top: 15px;
            right: 15px;
        }
        .size-btn {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            color: #bdc3c7;
            padding: 4px 10px;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
            margin-left: 2px;
        }
        .size-btn:hover { background: rgba(0,0,0,0.5); color: white; }
        .size-btn.active { background: #3498db; color: white; border-color: #3498db; }

        /* ìƒíƒœë°” */
        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-size: 16px;
            color: #bdc3c7;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 8px;
        }
        .score-highlight { color: #f1c40f; font-weight: bold; }
        
        /* ê¸€ì í‘œì‹œ */
        .display-char {
            font-size: var(--char-size);
            font-weight: bold;
            margin: 10px 0;
            min-height: calc(var(--char-size) * 1.4);
            color: #ecf0f1;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            line-height: 1.4;
        }
        
        /* ì…ë ¥ì°½ */
        #jp-typing-wrapper input {
            width: 90%;
            height: var(--input-height);
            padding: 0 10px;
            font-size: var(--input-font);
            text-align: center;
            border: none;
            border-radius: 5px;
            margin-bottom: 10px;
            background-color: #ecf0f1;
            color: #2c3e50;
            display: inline-block;
        }
        #jp-typing-wrapper input:focus { outline: 3px solid #3498db; }
        
        /* ë©”ì‹œì§€ */
        .message { height: 25px; font-weight: bold; margin-bottom: 5px; display: block; font-size: 16px;}
        .correct { color: #2ecc71; }
        .wrong { color: #e74c3c; }
        .hint { font-size: 16px; color: #f1c40f; height: 20px; transition: color 0.3s; margin-bottom: 10px; display: block; font-weight: bold;}

        /* ë²„íŠ¼ ê·¸ë£¹ (2ë‹¨ êµ¬ì„±) */
        .control-panel {
            margin-top: 15px; 
            border-top: 1px solid #7f8c8d; 
            padding-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .btn-row {
            display: flex;
            justify-content: center;
            gap: 5px;
        }
        .row-label {
            font-size: 12px; 
            color: #95a5a6; 
            margin-bottom: 2px;
            display: block;
        }
        
        .game-btn {
            padding: var(--btn-padding);
            font-size: var(--btn-font);
            cursor: pointer;
            background-color: #7f8c8d;
            color: white;
            border: none;
            border-radius: 5px;
            transition: 0.2s;
            flex: 1; /* ë²„íŠ¼ ë„ˆë¹„ ê· ë“± ë¶„ë°° */
        }
        .game-btn:hover { background-color: #95a5a6; }
        .game-btn.active { background-color: #3498db; font-weight: bold; transform: scale(1.02);}
        .game-btn.sub-active { background-color: #e67e22; font-weight: bold; transform: scale(1.02);}

        /* ê²°ê³¼ í™”ë©´ */
        #resultScreen {
            display: none;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(44, 62, 80, 0.98);
            border-radius: 15px;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        #resultScreen h2 { font-size: 32px; margin-bottom: 10px; color: #2ecc71; border: none; }
        .result-stat { font-size: 18px; margin: 5px 0; color: white;}
        
        .mistake-log-container {
            margin-top: 15px;
            width: 90%;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
            text-align: left;
        }
        .mistake-tag {
            display: inline-block;
            background-color: #c0392b;
            color: white;
            padding: 3px 6px;
            border-radius: 4px;
            margin: 3px;
            font-size: 13px;
        }
        
        .restart-btn {
            margin-top: 20px;
            padding: 12px 25px;
            font-size: 18px;
            background-color: #e67e22;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div id="jp-typing-wrapper">
    <div class="game-container">
        <div class="size-controls">
            <button class="size-btn" onclick="setWrapperSize('small')">ì‘ê²Œ</button>
            <button class="size-btn active" onclick="setWrapperSize('medium')" id="btnWrapperMedium">ë³´í†µ</button>
            <button class="size-btn" onclick="setWrapperSize('large')">í¬ê²Œ</button>
        </div>

        <h2 class="game-title">ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´ íƒ€ì ì—°ìŠµ</h2>
        
        <div class="status-bar">
            <span>ë‚¨ì€ ê¸€ì: <b id="remainCount">0</b></span>
            <span>
                ì ìˆ˜: <b id="score" class="score-highlight">0</b>
                <span class="max-score"> / <span id="maxScore">0</span></span>
            </span>
        </div>
        
        <div class="display-char" id="question">ì¤€ë¹„</div>
        
        <input type="text" id="userInput" placeholder="ë¡œë§ˆì (ì˜ˆ: a)" autocomplete="off">
        <div class="message" id="msg"></div>
        <div class="hint" id="hintBox"></div>

        <div class="control-panel">
            <div>
                <span class="row-label">ê¸€ì ì¢…ë¥˜</span>
                <div class="btn-row">
                    <button class="game-btn active" id="btnHira" onclick="setCharType('hira')">íˆë¼ê°€ë‚˜</button>
                    <button class="game-btn" id="btnKata" onclick="setCharType('kata')">ê°€íƒ€ì¹´ë‚˜</button>
                    <button class="game-btn" id="btnMix" onclick="setCharType('mix')">ì„ì–´ì„œ</button>
                </div>
            </div>
            <div>
                <span class="row-label">í•™ìŠµ ë²”ìœ„</span>
                <div class="btn-row">
                    <button class="game-btn sub-active" id="btnBasic" onclick="setScope('basic')">ì²­ìŒ(ê¸°ë³¸)</button>
                    <button class="game-btn" id="btnDaku" onclick="setScope('daku')">íƒìŒ/ë°˜íƒìŒ</button>
                    <button class="game-btn" id="btnAll" onclick="setScope('all')">ì „ì²´</button>
                </div>
            </div>
        </div>

        <div id="resultScreen">
            <h2>ğŸ‰ ì™„ë£Œ! ğŸ‰</h2>
            <div class="result-stat">ë‚´ ì ìˆ˜: <b id="finalScore" style="color:#f1c40f">0</b></div>
            <div class="result-stat" style="font-size:16px; color:#bdc3c7;">(ì´ ë§Œì : <span id="finalMaxScore">0</span>)</div>
            
            <div class="mistake-log-container">
                <div style="font-size: 14px; color: #e74c3c; margin-bottom: 5px; text-align: center;">â–¼ í‹€ë¦° ê¸€ì ëª©ë¡ â–¼</div>
                <div id="mistakeListContent"></div>
            </div>

            <button class="restart-btn" onclick="restartGame()">ë‹¤ì‹œ í•˜ê¸°</button>
        </div>
    </div>
</div>

<script>
    // 0. íŒíŠ¸ ë°ì´í„°
    const hintDict = {
        'ã‚':'ì•„ê¸° ì•„', 'ã„':'ì´ë¹¨ ì´', 'ã†':'ìš°ì‚° ìš°', 'ãˆ':'ì—ì–´ë¡œë¹… ì—', 'ãŠ':'ì˜¤ë¦¬ ì˜¤',
        'ã‹':'ì¹´ë©”ë¼ ì¹´', 'ã':'ê¸°íƒ€ í‚¤', 'ã':'ì¿ ì…˜ ì¿ ', 'ã‘':'ê³„ì‚°ê¸° ì¼€', 'ã“':'ì½”ë¼ë¦¬ ì½”',
        'ã•':'ì‚¬ê³¼ ì‚¬', 'ã—':'ë‚šì‹œ ì‹œ', 'ã™':'ìŠ¤í”„ë§ ìŠ¤', 'ã›':'ì„¸ìˆ«ëŒ€ ì„¸', 'ã':'ì†Œë¼ ì†Œ',
        'ãŸ':'íƒ€ì¡° íƒ€', 'ã¡':'ì¹˜íƒ€ ì¹˜', 'ã¤':'ë¶€ì¸  ì¸ ', 'ã¦':'í…Œì´í”„ í…Œ', 'ã¨':'í† ë¼ í† ',
        'ãª':'ë‚˜ë¹„ ë‚˜', 'ã«':'ë°”êµ¬ë‹ˆ ë‹ˆ', 'ã¬':'ëˆ„ì— ëˆ„', 'ã­':'ê·¸ë„¤ ë„¤', 'ã®':'ë…¸ë˜ ë…¸',
        'ã¯':'í• ì•„ë²„ì§€ í•˜', 'ã²':'íˆí‹€ëŸ¬ íˆ', 'ãµ':'í›„ë¼ì´íŒ¬ í›„', 'ã¸':'í—¤ì—„ í—¤', 'ã»':'í˜¸ë‘ì´ í˜¸',
        'ã¾':'ë§ˆë¼í†¤ ë§ˆ', 'ã¿':'ë¯¸ë¡œ ë¯¸', 'ã‚€':'ë¬´ìš© ë¬´', 'ã‚':'ë©”ê¸° ë©”', 'ã‚‚':'ëª¨ì ëª¨',
        'ã‚„':'ì•¼êµ¬ ì•¼', 'ã‚†':'ìœ ë„ ìœ ', 'ã‚ˆ':'ìš”íŠ¸ ìš”',
        'ã‚‰':'ë¼ë””ì˜¤ ë¼', 'ã‚Š':'ë¦¬ë³¸ ë¦¬', 'ã‚‹':'ìº¥ê±°ë£¨ ë£¨', 'ã‚Œ':'ë ˆìŠ¬ë§ ë ˆ', 'ã‚':'ë¡¤ëŸ¬ìŠ¤ì¼€ì´íŠ¸ ë¡œ',
        'ã‚':'ì™€~(ê°íƒ„ì‚¬) ì™€', 'ã‚’':'ì˜¤ì§•ì–´ ì˜¤', 'ã‚“':'ì‘ê°€ ì‘',
        'ã‚¢':'ì•„ì´ìŠ¤í¬ë¦¼ ì•„', 'ã‚¤':'ìƒì–´ì´ë¹¨ ì´', 'ã‚¦':'ìš°ì‚° ìš°', 'ã‚¨':'ì—ì–´ë¡œë¹… ì—', 'ã‚ª':'ì˜¤ì§•ì–´ ì˜¤',
        'ã‚«':'ì¹´ë©”ë¼ ì¹´', 'ã‚­':'ê¸°íƒ€ í‚¤', 'ã‚¯':'í¬ë ˆíŒŒìŠ¤ ì¿ ', 'ã‚±':'ì¼€ì´í¬ ì¼€', 'ã‚³':'ì½˜ì„¼íŠ¸ ì½”',
        'ã‚µ':'ì‚¬ìŠ´ ì‚¬', 'ã‚·':'ì‹œê³„ ì‹œ', 'ã‚¹':'ìŠ¤ì¼€ì´íŠ¸ ìŠ¤', 'ã‚»':'ì„¸ìˆ«ëŒ€ ì„¸', 'ã‚½':'ì†Œì„¸ì§€ ì†Œ',
        'ã‚¿':'íƒ€ì˜¬ íƒ€', 'ãƒ':'ì¹˜ì¦ˆ ì¹˜', 'ãƒ„':'ì“°ë‚˜ë¯¸(ì¸ ë‚˜ë¯¸) ì¸ ', 'ãƒ†':'í…Œì´ë¸” í…Œ', 'ãƒˆ':'í† ì¸ í† ',
        'ãƒŠ':'ë‚˜ë¹„ ë‚˜', 'ãƒ‹':'ë°”êµ¬ë‹ˆ ë‹ˆ', 'ãƒŒ':'ëˆ„ë”ê¸°ì˜· ëˆ„', 'ãƒ':'ë„¤íŠ¸ì›Œí¬ ë„¤', 'ãƒ':'ë…¸íŠ¸ ë…¸',
        'ãƒ':'í•˜ë§ˆ í•˜', 'ãƒ’':'íˆí„° íˆ', 'ãƒ•':'ë§ˆí›„ë¼(ë¨¸í”ŒëŸ¬) í›„', 'ãƒ˜':'í—¤ì—„ í—¤', 'ãƒ›':'í˜¸í…” í˜¸',
        'ãƒ':'ë§ˆì´í¬ ë§ˆ', 'ãƒŸ':'ë¯¸ì‚¬ì¼ ë¯¸', 'ãƒ ':'ë¬´ ë¬´', 'ãƒ¡':'ë©”ë¡  ë©”', 'ãƒ¢':'ëª¨ì ëª¨',
        'ãƒ¤':'ì•¼êµ¬ ì•¼', 'ãƒ¦':'ìœ ë¦¬ ìœ ', 'ãƒ¨':'ìš”íŠ¸ ìš”',
        'ãƒ©':'ë¼ì´íƒ€ ë¼', 'ãƒª':'ë¦¬ë³¸ ë¦¬', 'ãƒ«':'ìº¥ê±°ë£¨ ë£¨', 'ãƒ¬':'ë ˆëª¬ ë ˆ', 'ãƒ­':'ë¡œë´‡ ë¡œ',
        'ãƒ¯':'ì™€ì¸ì” ì™€', 'ãƒ²':'ì˜¤í† ë°”ì´ ì˜¤', 'ãƒ³':'ì€í–‰ë‚˜ë­‡ì ì‘'
    };

    // 1. ë°ì´í„° ë² ì´ìŠ¤ ë¶„ë¦¬ (ì²­ìŒ / íƒìŒ&ë°˜íƒìŒ)
    
    // [ì²­ìŒ] 46ì
    const hira_basic = {
        'ã‚':'a', 'ã„':'i', 'ã†':'u', 'ãˆ':'e', 'ãŠ':'o',
        'ã‹':'ka', 'ã':'ki', 'ã':'ku', 'ã‘':'ke', 'ã“':'ko',
        'ã•':'sa', 'ã—':'si', 'ã™':'su', 'ã›':'se', 'ã':'so',
        'ãŸ':'ta', 'ã¡':'ti', 'ã¤':'tu', 'ã¦':'te', 'ã¨':'to',
        'ãª':'na', 'ã«':'ni', 'ã¬':'nu', 'ã­':'ne', 'ã®':'no',
        'ã¯':'ha', 'ã²':'hi', 'ãµ':'hu', 'ã¸':'he', 'ã»':'ho',
        'ã¾':'ma', 'ã¿':'mi', 'ã‚€':'mu', 'ã‚':'me', 'ã‚‚':'mo',
        'ã‚„':'ya', 'ã‚†':'yu', 'ã‚ˆ':'yo',
        'ã‚‰':'ra', 'ã‚Š':'ri', 'ã‚‹':'ru', 'ã‚Œ':'re', 'ã‚':'ro',
        'ã‚':'wa', 'ã‚’':'wo', 'ã‚“':'nn'
    };
    const kata_basic = {
        'ã‚¢':'a', 'ã‚¤':'i', 'ã‚¦':'u', 'ã‚¨':'e', 'ã‚ª':'o',
        'ã‚«':'ka', 'ã‚­':'ki', 'ã‚¯':'ku', 'ã‚±':'ke', 'ã‚³':'ko',
        'ã‚µ':'sa', 'ã‚·':'si', 'ã‚¹':'su', 'ã‚»':'se', 'ã‚½':'so',
        'ã‚¿':'ta', 'ãƒ':'ti', 'ãƒ„':'tu', 'ãƒ†':'te', 'ãƒˆ':'to',
        'ãƒŠ':'na', 'ãƒ‹':'ni', 'ãƒŒ':'nu', 'ãƒ':'ne', 'ãƒ':'no',
        'ãƒ':'ha', 'ãƒ’':'hi', 'ãƒ•':'hu', 'ãƒ˜':'he', 'ãƒ›':'ho',
        'ãƒ':'ma', 'ãƒŸ':'mi', 'ãƒ ':'mu', 'ãƒ¡':'me', 'ãƒ¢':'mo',
        'ãƒ¤':'ì•¼êµ¬ ì•¼', 'ãƒ¦':'ìœ ë¦¬ ìœ ', 'ãƒ¨':'ìš”íŠ¸ ìš”',
        'ãƒ©':'ra', 'ãƒª':'ri', 'ãƒ«':'ru', 'ãƒ¬':'re', 'ãƒ­':'ro',
        'ãƒ¯':'wa', 'ãƒ²':'wo', 'ãƒ³':'nn'
    };

    // [íƒìŒ & ë°˜íƒìŒ] 25ì
    const hira_daku = {
        'ãŒ':'ga', 'ã':'gi', 'ã':'gu', 'ã’':'ge', 'ã”':'go',
        'ã–':'za', 'ã˜':'ji', 'ãš':'zu', 'ãœ':'ze', 'ã':'zo',
        'ã ':'da', 'ã¢':'di', 'ã¥':'du', 'ã§':'de', 'ã©':'do',
        'ã°':'ba', 'ã³':'bi', 'ã¶':'bu', 'ã¹':'be', 'ã¼':'bo',
        'ã±':'pa', 'ã´':'pi', 'ã·':'pu', 'ãº':'pe', 'ã½':'po'
    };
    const kata_daku = {
        'ã‚¬':'ga', 'ã‚®':'gi', 'ã‚°':'gu', 'ã‚²':'ge', 'ã‚´':'go',
        'ã‚¶':'za', 'ã‚¸':'ji', 'ã‚º':'zu', 'ã‚¼':'ze', 'ã‚¾':'zo',
        'ãƒ€':'da', 'ãƒ‚':'di', 'ãƒ…':'du', 'ãƒ‡':'de', 'ãƒ‰':'do',
        'ãƒ':'ba', 'ãƒ“':'bi', 'ãƒ–':'bu', 'ãƒ™':'be', 'ãƒœ':'bo',
        'ãƒ‘':'pa', 'ãƒ”':'pi', 'ãƒ—':'pu', 'ãƒš':'pe', 'ãƒ':'po'
    };

    // 2. ë³€ìˆ˜
    let questionDeck = []; 
    let currentDict = {}; 
    let currentKey = '';    
    let currentAnswer = ''; 
    let score = 0;
    let totalMaxScore = 0; 
    let questionStartTime = 0;
    let consecutiveMistakes = 0;
    let mistakeHistory = {}; 

    // í˜„ì¬ ì„¤ì • ìƒíƒœ (ê¸°ë³¸ê°’)
    let selectedCharType = 'hira'; // hira, kata, mix
    let selectedScope = 'basic';    // basic, daku, all

    // DOM ìš”ì†Œ
    const wrapper = document.getElementById('jp-typing-wrapper');
    const questionEl = document.getElementById('question');
    const inputEl = document.getElementById('userInput');
    const msgEl = document.getElementById('msg');
    const hintEl = document.getElementById('hintBox');
    const scoreEl = document.getElementById('score');
    const maxScoreEl = document.getElementById('maxScore');
    const remainEl = document.getElementById('remainCount');
    const resultScreen = document.getElementById('resultScreen');
    const mistakeListEl = document.getElementById('mistakeListContent');

    // í™”ë©´ í¬ê¸° ì¡°ì ˆ
    function setWrapperSize(size) {
        wrapper.classList.remove('size-small', 'size-large');
        document.querySelectorAll('.size-btn').forEach(btn => btn.classList.remove('active'));
        if (size === 'small') {
            wrapper.classList.add('size-small');
            document.querySelector("button[onclick=\"setWrapperSize('small')\"]").classList.add('active');
        } else if (size === 'large') {
            wrapper.classList.add('size-large');
            document.querySelector("button[onclick=\"setWrapperSize('large')\"]").classList.add('active');
        } else {
            document.getElementById('btnWrapperMedium').classList.add('active');
        }
        inputEl.focus();
    }

    // ì„¤ì • ë³€ê²½ í•¨ìˆ˜
    function setCharType(type) {
        selectedCharType = type;
        // UI ì—…ë°ì´íŠ¸
        document.getElementById('btnHira').classList.remove('active');
        document.getElementById('btnKata').classList.remove('active');
        document.getElementById('btnMix').classList.remove('active');
        
        if(type === 'hira') document.getElementById('btnHira').classList.add('active');
        else if(type === 'kata') document.getElementById('btnKata').classList.add('active');
        else document.getElementById('btnMix').classList.add('active');

        startGame();
    }

    function setScope(scope) {
        selectedScope = scope;
        // UI ì—…ë°ì´íŠ¸
        document.getElementById('btnBasic').classList.remove('sub-active');
        document.getElementById('btnDaku').classList.remove('sub-active');
        document.getElementById('btnAll').classList.remove('sub-active');
        
        if(scope === 'basic') document.getElementById('btnBasic').classList.add('sub-active');
        else if(scope === 'daku') document.getElementById('btnDaku').classList.add('sub-active');
        else document.getElementById('btnAll').classList.add('sub-active');

        startGame();
    }

    function restartGame() {
        startGame();
    }

    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // ê²Œì„ ë°ì´í„° êµ¬ì„± ë° ì‹œì‘
    function startGame() {
        score = 0;
        mistakeHistory = {}; 
        currentDict = {};

        // 1. ë²”ìœ„(Scope)ì— ë”°ë¼ ê¸°ë³¸ ë°ì´í„°ì…‹ ì¤€ë¹„
        let useHira = {};
        let useKata = {};

        if (selectedScope === 'basic') {
            useHira = {...hira_basic};
            useKata = {...kata_basic};
        } else if (selectedScope === 'daku') {
            useHira = {...hira_daku};
            useKata = {...kata_daku};
        } else { // all
            useHira = {...hira_basic, ...hira_daku};
            useKata = {...kata_basic, ...kata_daku};
        }

        // 2. ê¸€ì ì¢…ë¥˜(CharType)ì— ë”°ë¼ ë³‘í•©
        if (selectedCharType === 'hira') {
            currentDict = useHira;
        } else if (selectedCharType === 'kata') {
            currentDict = useKata;
        } else { // mix
            currentDict = {...useHira, ...useKata};
        }

        const totalChars = Object.keys(currentDict).length;
        totalMaxScore = totalChars * 100;
        maxScoreEl.innerText = totalMaxScore;

        questionDeck = shuffle(Object.keys(currentDict));
        
        scoreEl.innerText = score;
        msgEl.innerText = "ì‹œì‘!";
        msgEl.className = "message";
        hintEl.innerText = "";
        resultScreen.style.display = 'none';
        
        nextQuestion();
        inputEl.focus();
    }

    function nextQuestion() {
        if (questionDeck.length === 0) {
            endGame();
            return;
        }
        remainEl.innerText = questionDeck.length; 
        currentKey = questionDeck.pop(); 
        currentAnswer = currentDict[currentKey];
        consecutiveMistakes = 0;
        questionEl.innerText = currentKey;
        inputEl.value = '';
        msgEl.innerText = ""; // ì´ì „ ë©”ì‹œì§€ ì´ˆê¸°í™”
        hintEl.innerText = ""; // íŒíŠ¸ ì´ˆê¸°í™”
        questionStartTime = Date.now();
    }

    inputEl.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            // ê²Œì„ ëë‚œ í›„ ì—”í„°í‚¤ ë°©ì§€
            if (questionDeck.length === 0 && questionEl.innerText === "ë") return;
            
            const userInput = inputEl.value.toLowerCase().trim();
            // ë¹ˆ ê°’ ì…ë ¥ ë°©ì§€
            if (userInput === '') return;

            if (userInput === currentAnswer) {
                const now = Date.now();
                const timeTaken = (now - questionStartTime) / 1000;
                const timeScore = Math.max(20, Math.floor(100 - (timeTaken * 5)));
                score += timeScore;
                msgEl.innerText = `ì •ë‹µ! (+${timeScore}ì )`;
                msgEl.className = "message correct";
                hintEl.innerText = ""; 
                scoreEl.innerText = score;
                nextQuestion();
            } else {
                if (!mistakeHistory[currentKey]) mistakeHistory[currentKey] = 0;
                mistakeHistory[currentKey]++;
                consecutiveMistakes++; 
                score = Math.max(0, score - 5);
                scoreEl.innerText = score;
                inputEl.value = ''; 

                // 2ë²ˆ ì´ìƒ í‹€ë¦¬ë©´ ì •ë‹µ ê³µê°œ (ê¸°íšŒ 2ë²ˆ)
                if (consecutiveMistakes >= 2) {
                    msgEl.innerText = "2íšŒ ì˜¤ë¥˜! ì •ë‹µ ê³µê°œ";
                    msgEl.className = "message wrong";
                    // ì •ë‹µ ê³µê°œ (ë¹¨ê°„ìƒ‰)
                    hintEl.innerText = `ì •ë‹µì€ '${currentAnswer}' ì…ë‹ˆë‹¤.`;
                    hintEl.style.color = "#e74c3c"; 
                } else {
                    // 1ë²ˆ í‹€ë ¸ì„ ë•Œ -> íŒíŠ¸ ì œê³µ
                    msgEl.innerText = "ë•¡! í‹€ë ¸ìŠµë‹ˆë‹¤.";
                    msgEl.className = "message wrong";
                    // íŒíŠ¸ ì œê³µ (ë…¸ë€ìƒ‰)
                    hintEl.style.color = "#f1c40f";
                    if (hintDict[currentKey]) {
                        hintEl.innerText = `íŒíŠ¸: ${hintDict[currentKey]}`;
                    } else {
                        // íŒíŠ¸ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°
                        hintEl.innerText = `(íŒíŠ¸ ë°ì´í„° ì—†ìŒ)`;
                    }
                }
            }
        }
    });

    function endGame() {
        questionEl.innerText = "ë";
        remainEl.innerText = "0";
        inputEl.blur(); 
        document.getElementById('finalScore').innerText = score;
        document.getElementById('finalMaxScore').innerText = totalMaxScore;
        mistakeListEl.innerHTML = ''; 
        const sortedMistakes = Object.entries(mistakeHistory).sort((a, b) => b[1] - a[1]);

        if (sortedMistakes.length === 0) {
            mistakeListEl.innerHTML = '<span style="color:#2ecc71; font-weight:bold;">ì™„ë²½í•©ë‹ˆë‹¤!</span>';
        } else {
            sortedMistakes.forEach(([char, count]) => {
                const tag = document.createElement('div');
                tag.className = 'mistake-tag';
                tag.innerHTML = `<b>${char}</b> : ${count}íšŒ`;
                mistakeListEl.appendChild(tag);
            });
        }
        resultScreen.style.display = 'flex';
    }

    // ì´ˆê¸° ì‹œì‘
    startGame();
</script>

</body>
</html>
